name: Zephyr Deployment

on: [workflow_call]

# Needed for nx-set-shas when run on the main branch
permissions:
    actions: read
    pull-requests: write
    contents: read

jobs:
    zephyr-deployment:
        runs-on: ubuntu-latest
        timeout-minutes: 10 # Set a timeout for the job to prevent it from running indefinitely
        steps:
            - uses: actions/checkout@v4
              with:
                fetch-depth: 0
            - uses: ./.github/actions/setup-dependencies
            - uses: nrwl/nx-set-shas@v4
            - name: Deploy to Zephyr
              shell: bash
              env:
                  ZE_SECRET_TOKEN: ${{ secrets.ZE_SECRET_TOKEN }}
                  WITH_ZE: "1"
                  ZC: "1"
              run: |
                if [ -z "$ZE_SECRET_TOKEN" ]; then
                  echo "Error: ZE_SECRET_TOKEN is not set"
                  exit 1
                fi
                pnpm nx affected -t bundle:ios